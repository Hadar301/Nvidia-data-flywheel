apiVersion: v1
kind: ConfigMap
metadata:
  name: nemo-gateway-config
  namespace: hacohen-flywheel
data:
  nginx.conf: |
    events {
      worker_connections 1024;
    }

    http {
      # OpenShift internal DNS resolver
      resolver 172.30.0.10 valid=30s;

      # Enable access logging
      access_log /var/log/nginx/access.log;
      error_log /var/log/nginx/error.log;

      # Allow large file uploads for Git LFS and dataset uploads
      client_max_body_size 100M;

      server {
        listen 8080;

        # Health check endpoint for the gateway itself
        location /healthz {
          return 200 'OK';
          add_header Content-Type text/plain;
        }

        # Route to Entity Store (Dataset metadata registration)
        location /v1/datasets {
          set $upstream_entitystore nemoentitystore-sample.hacohen-flywheel.svc.cluster.local:8000;
          proxy_pass http://$upstream_entitystore;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Route to Customizer (Fine-tuning jobs, LoRA configs)
        location /v1/customization {
          set $upstream_customizer nemocustomizer-sample.hacohen-flywheel.svc.cluster.local:8000;
          proxy_pass http://$upstream_customizer;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Route to Evaluator (Model evaluation jobs)
        location /v1/evaluation {
          set $upstream_evaluator nemoevaluator-sample.hacohen-flywheel.svc.cluster.local:8000;
          proxy_pass http://$upstream_evaluator;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Route to Guardrails (Safety filters)
        location /v1/guardrails {
          set $upstream_guardrail nemoguardrails-sample.hacohen-flywheel.svc.cluster.local:8000;
          proxy_pass http://$upstream_guardrail;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Route to Entity Store (Model metadata, PEFT models)
        location /v1/entity-store {
          set $upstream_entitystore nemoentitystore-sample.hacohen-flywheel.svc.cluster.local:8000;
          proxy_pass http://$upstream_entitystore;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Route for namespaces (needed by Data Flywheel - routes to Entity Store)
        location /v1/namespaces {
          set $upstream_entitystore nemoentitystore-sample.hacohen-flywheel.svc.cluster.local:8000;
          proxy_pass http://$upstream_entitystore;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Route for datastore namespace operations
        location /v1/datastore {
          set $upstream_datastore nemodatastore-sample.hacohen-flywheel.svc.cluster.local:8000;
          proxy_pass http://$upstream_datastore;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Route for HuggingFace API (through Datastore)
        location /v1/hf {
          set $upstream_datastore nemodatastore-sample.hacohen-flywheel.svc.cluster.local:8000;
          proxy_pass http://$upstream_datastore;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Route Git/LFS operations to Datastore (for HuggingFace Hub compatibility)
        # Matches paths like: /{namespace}/{repo}.git/info/lfs/...
        location ~ ^/[^/]+/.+\.git/ {
          set $upstream_datastore nemodatastore-sample.hacohen-flywheel.svc.cluster.local:8000;
          proxy_pass http://$upstream_datastore;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Mock deployment API for statically deployed NIMs
        # Returns success for deployment requests since NIMs are pre-deployed via NeMo Operator
        location ~ ^/v1/deployment/model-deployments/?$ {
          default_type application/json;
          return 200 '{"status": "success", "status_details": {"status": "ready"}, "message": "NIM deployment successful (pre-deployed)"}';
        }

        # Mock deployment status check for statically deployed NIMs
        location ~ ^/v1/deployment/model-deployments/[^/]+/[^/]+$ {
          default_type application/json;
          return 200 '{"status": "ready", "status_details": {"status": "ready"}, "deployment_status": "running", "message": "NIM is pre-deployed and ready"}';
        }

        # Mock model metadata endpoint for base model evaluations
        # Use "default" namespace to match registered model
        # api_endpoint structured as object per Pydantic APIEndpointData schema with required model_id field
        # model_id must match NIM's expected format: "meta/llama-3.2-1b-instruct" (with forward slash)
        location ~ ^/v1/models/meta/llama-3\.2-1b-instruct$ {
          default_type application/json;
          return 200 '{"created_at":"2026-02-03T00:00:00.000000","updated_at":"2026-02-03T00:00:00.000000","name":"llama-3.2-1b-instruct","namespace":"meta","description":"Llama 3.2 1B Instruct","spec":{"num_parameters":1000000000,"context_size":8192,"num_virtual_tokens":0,"is_chat":true},"artifact":{"gpu_arch":"ampere","precision":"fp16","tensor_parallelism":1,"status":"upload_completed","files_url":"hf://meta-llama/Llama-3.2-1B-Instruct"},"base_model":"meta/llama-3.2-1b-instruct","schema_version":"1.0","project":"data-flywheel","custom_fields":{}}';
        }

        # Route for customized model metadata - proxy to Entity Store
        location ~ ^/v1/models/[^/]+/customized-.+$ {
          set $upstream_entitystore nemoentitystore-sample.hacohen-flywheel.svc.cluster.local:8000;
          proxy_pass http://$upstream_entitystore;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Default catch-all (return 404 for unknown paths)
        location / {
          return 404 '{"error": "Not Found - use /v1/* endpoints for NeMo services or Git repository paths"}';
          add_header Content-Type application/json;
        }
      }
    }
